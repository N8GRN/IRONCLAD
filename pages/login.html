<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.1, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="IRONCLAD CRM">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">

  <!-- Apple Splash Screens -->
  <link rel="apple-touch-startup-image"
    media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="../img/splash/splash-2048x2732.png">
  <link rel="apple-touch-startup-image"
    media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="../img/splash/splash-1668x2388.png">
  <link rel="apple-touch-startup-image"
    media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="../img/splash/splash-1536x2048.png">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../favicon.png">
  <link rel="icon" type="image/png" href="../favicon.png">
  <link rel="shortcut icon" href="../favicon.png">

  <link rel="manifest" href="../manifest.json">
  <link rel="apple-touch-icon" href="../img/icons/apple-touch-icon.png">
  <link rel="stylesheet" href="../css/styles.css">

  <title>IRONCLAD CRM - Sign In</title>

  <style>
    html,
    body {
      margin: 0;
      height: 100dvh;
      /*background: linear-gradient(135deg, #1e3c72, #2a5298);*/
      background: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .login-container {
      /*background: rgba(255, 255, 255, 0.12);*/
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      backdrop-filter: blur(16px);
      opacity: 1;
      padding: 3rem 2.5rem;
      border-radius: 24px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
      text-align: center;
      width: 90%;
      max-width: 440px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .logo {
      width: 120px;
      height: 120px;
      margin-bottom: 2rem;
      border-radius: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    h1 {
      margin: 0 0 2rem 0;
      font-weight: 600;
      font-size: 2.2rem;
    }

    h3 {
      margin: 1.5rem 0 1rem 0;
      font-weight: 500;
      font-size: 1.4rem;
    }

    input {
      width: calc(100% - 2rem);
      padding: 1rem;
      margin: 0.8rem 0;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      backdrop-filter: blur(8px);
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    button {
      width: 100%;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #authMessage {
      margin-top: 1.5rem;
      min-height: 1.5rem;
      font-weight: 500;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .button-group button {
      flex: 1;
    }

    .small-link {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: underline;
      cursor: pointer;
      margin-top: 0.5rem;
      display: inline-block;
    }
  </style>
</head>

<body>

  <div class="login-container">
    <img src="../img/icons/icon-192x192.png" alt="IRONCLAD Logo" class="logo">
    <h1>IRONCLAD CRM</h1>

    <!-- Register Section -->
    <div id="register-section" style="display: none ">
      <h3>Create Your Account</h3>
      <input type="text" id="registerUsername" placeholder="Username (e.g., Nathan)" required />
      <input type="email" id="registerEmail" placeholder="Email Address" required />
      <input type="password" id="registerPassword" placeholder="Password (6+ characters)" required />
      <button id="registerBtn">Register</button>
      <div class="small-link" id="switchToLogin">I already have an account</div>
    </div>

    <!-- Login Section -->
    <div id="login-section" style="margin-top: 2rem;">
      <h3>Sign In</h3>
      <input type="email" id="loginEmail" placeholder="Email Address" required />
      <input type="password" id="loginPassword" placeholder="Password" required />
      <div class="button-group">
        <button id="loginBtn">Sign In</button>
        <button id="forgotPasswordBtn">Forgot?</button>
      </div>
      <div class="small-link" id="switchToRegister">New here? Create an account</div>
    </div>

    <p id="authMessage"></p>
  </div>

  <!-- Load core modules -->
  <script type="module" src="/IRONCLAD/js/modules.js"></script>
  <script src="/IRONCLAD/js/db.js"></script>
  <script src="/IRONCLAD/js/app.js"></script>

  <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const registerUsername = document.getElementById('registerUsername');
      const registerEmail = document.getElementById('registerEmail');
      const registerPassword = document.getElementById('registerPassword');
      const registerBtn = document.getElementById('registerBtn');

      const loginEmail = document.getElementById('loginEmail');
      const loginPassword = document.getElementById('loginPassword');
      const loginBtn = document.getElementById('loginBtn');
      const forgotBtn = document.getElementById('forgotPasswordBtn');

      const messageEl = document.getElementById('authMessage');
      const registerSection = document.getElementById('register-section');
      const loginSection = document.getElementById('login-section');
      const switchLink = document.getElementById('switchToRegister');
      const switchLink2 = document.getElementById('switchToLogin');

      function showMessage(text, isError = false) {
        messageEl.textContent = text;
        messageEl.style.color = isError ? '#ff4444' : '#44ff44';
        messageEl.style.fontWeight = 'bold';
      }

      // Register handler
      registerBtn.addEventListener('click', async () => {
        const username = registerUsername.value.trim();
        const email = registerEmail.value.trim();
        const password = registerPassword.value;

        if (!username || !email || !password) {
          showMessage('Please fill in username, email, and password.', true);
          return;
        }

        registerBtn.disabled = true;
        showMessage('Creating your account...');

        const result = await window.AuthAPI.register(email, password, username);

        registerBtn.disabled = false;

        if (result.success) {
          showMessage(`Welcome, ${username}! Redirecting...`, false);
          setTimeout(() => {
            window.location.href = '/IRONCLAD/pages/projects.html';
          }, 1500);
        } else {
          showMessage(result.message || 'Registration failed.', true);
        }
      });

      // Login handler
      loginBtn.addEventListener('click', async () => {
        const email = loginEmail.value.trim();
        const password = loginPassword.value;

        if (!email || !password) {
          showMessage('Please enter email and password.', true);
          return;
        }

        loginBtn.disabled = true;
        showMessage('Signing in...');

        const result = await window.AuthAPI.login(email, password);

        loginBtn.disabled = false;

        if (result.success) {
          showMessage('Welcome back! Redirecting...', false);
          setTimeout(() => {
            window.location.href = '/IRONCLAD/pages/home.html';
          }, 1500);
        } else {
          showMessage(result.message || 'Login failed.', true);
        }
      });

      // Forgot password
      forgotBtn.addEventListener('click', async () => {
        const email = loginEmail.value.trim() || prompt('Enter your email:');
        if (!email) return;

        showMessage('Sending reset link...');
        const result = await window.AuthAPI.resetPassword(email);
        //showMessage('Reset email sent! Check your inbox (including spam/junk folder).', false);
        showMessage(result.message || 'Check your email.', !result.success);
      });

      // Simple toggle between login/register (optional UX)
      switchLink.addEventListener('click', () => {
        registerSection.style.display = registerSection.style.display === 'none' ? 'block' : 'none';
        loginSection.style.display = loginSection.style.display === 'none' ? 'block' : 'none';
      });

      switchLink2.addEventListener('click', () => {
        registerSection.style.display = registerSection.style.display === 'none' ? 'block' : 'none';
        loginSection.style.display = loginSection.style.display === 'none' ? 'block' : 'none';
      });

    });

    navigator.serviceWorker.getRegistration().then(reg => {
      if (reg) reg.update(); // Force check for new SW
    });
  </script>

</body>

</html>